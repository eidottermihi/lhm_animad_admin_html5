<link rel="import" href="../common-libs/traverson.html">
<link rel="import" href="../common-libs/traverson-hal.html">

<script>
    /**
     * Behavior, um einem beliebigen Formular (Update, Create, Read) alle Eigenschaften
     * wie Properties und Methoden zu geben, die es benötigt um mit dem Server zu 
     * kommunizieren.
     * 
     * @polymerMixinClass
     */
    /* @polymerMixin */
    let AnimadFormBehavior = (superClass) => class extends superClass {

        static get properties() {
            return {
                /**
                 * Url um die Formulardaten zu laden.
                 */
                url: {
                    type: String,
                    observer: '_loadFormData'
                },
                /**
                 * Das leere Objekt.
                 *   
                 * @type{}
                 */
                data: {
                    type: Object,
                    notify: true
                },
                /**
                 *
                 */
                _error: {
                    type: String
                },
                /**
                 *
                 */
                _errorToast: {
                    type: Object,
                    value() {
                        return document.querySelector('#global_error_toast');
                    }
                },
                /**
                 *
                 */
                _successToast: {
                    type: Object,
                    value() {
                        return document.querySelector('#global_success_toast');
                    }
                },
                /**
                 *
                 */
                _warningToast: {
                    type: Object,
                    value() {
                        return document.querySelector('#global_warning_toast');
                    }
                }
            }
        }

        /*
         * Wird von 'create' Formularen aufgerufen, um eine neue Entität
         * zu speichern.
         */
        _saveEntity() {
            this._send('POST', this.url, this.data);
        }

        /*
         * Wird von 'update' Formularen aufgerufen, um eine bereits
         * bestehende Entität zu aktualisieren.
         */
        _updateEntity() {
            this._send('PUT', this.url, this.data);
        }

        /**
         * Validiert die Formulardaten. Danach werden sie an die angegebene
         * URL als JSON Objekt gesendet.
         */
        _send(verb, url, payload) {
            // check if the formcontent is valid against the defined rules
            var valid = this.shadowRoot.querySelector('#iform').validate();

            console.log(verb);
            console.log(url);
            console.log(payload);

            if (valid) {
                
                // prepare request
                var init = {
                    method: verb,
                    mode: 'cors',
                    body: JSON.stringify(payload)
                }

                var request = new Request(url, init);

                fetch(request)
                    .then(response => {
                        if (response.ok) {
                            this._resetForm();
                            this._success();
                            console.log(response.json());
                        } else {
                            this._error(response.status);
                        }
                    })
            } else {
                console.log("form is not valid...");
                this._warningToast.text = this.t('form_validation');
                this._warningToast.open();
            }

        }

        /*
         * Holt sich eine HAL Resource über die URL, die im Property 
         * 'url' gespeichert ist. Die Nutzdaten werden im 'data' 
         * Property gespeichert. Danach werden alle benötigten Links 
         * aufgelöst.
         */
        _loadFormData(url, oldV) {

            if (url) {

                // register HAL adapter in Traverson's media type registry
                traverson.registerMediaType(TraversonJsonHalAdapter.mediaType,
                    TraversonJsonHalAdapter);

                traverson
                    .from(url)
                    .jsonHal()
                    .get((error, document, traversal) => {
                        if (error) {
                            console.error('_traversFormData(): No luck :)');
                        } else {
                            this.set('data', JSON.parse(document.body));

                            // Das Traversal Objekt wird im Property
                            // 'traversal' gespeichert. Dadurch wird 
                            // es automatisch an untergeordnete Elemente
                            // wie beispielsweise Relationen weiter gegegen. 
                            this.set('_traversal', traversal);
                        }
                    });
            }
        }

        _reloadForm() {
            this._loadFormData(this.url, null);
        }

        /**
         * Setzt das Formular zurück.
         */
        _resetForm() {
            this.shadowRoot.querySelector('#iform').reset();
            this._reloadForm();
        }

        /**
         * Macht ein 'readonly' Formular editierbar.
         */
        _editForm() {
            if (this.readform) {
                this.set('readform', false);
            }
        }

        /**
         * Der 'Toast', der bei Erfolg angezeigt wird.
         */
        _success() {
            this._successToast.text = this.t('form_success');
            this._successToast.open();
        }

        /**
         * Der 'Toast', der bei Fehlern angezeigt wird.
         */
        _error(status) {
            this._errorToast.text = this.t('form_error', { code: status });
            this._errorToast.open();
        }
    };
</script>